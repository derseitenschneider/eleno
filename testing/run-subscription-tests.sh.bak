#!/usr/bin/env bash
# Test user id
USER_ID='c352cb96-41e4-47ac-81bd-a77bf7865c92'
APP_DIR="$PWD/../app"

# Function to run tests for a state
run_state_tests() {
    local STATE=$1
    shift # Remove the state argument
    local ORIGINAL_DIR="$PWD" # Store the original directory

    echo "Testing subscription state: $STATE"
    echo "for user $USER_ID"

    # Apply the state using your PHP script that uses SubscriptionStates
    php set-subscription-state.php --state="$STATE" --user="$USER_ID"

    cd "$APP_DIR"

    # Run Playwright tests for each provided directory
    local RESULT=0
    for TEST_DIR in "$@"; do
        echo "Running tests in: $TEST_DIR"
        npm run pw -- "$TEST_DIR"
        local CURRENT_RESULT=$?
        if [ $CURRENT_RESULT -ne 0 ]; then
            RESULT=$CURRENT_RESULT # Store the first error
        fi
        echo "Tests in $TEST_DIR completed with status: $CURRENT_RESULT"
    done

    cd "$ORIGINAL_DIR"
    return $RESULT
}

# Run tests for each subscription state
echo "Running tests for trial subscription..."
run_state_tests "trial" "tests/stripe/common/trial" "tests/stripe/trial/specific"

echo "Running tests for monthly active subscription..."
run_state_tests "monthly-active" "tests/stripe/common/monthly" "tests/stripe/monthly/specific"

# ... more states

# Clean up
echo "Cleaning up test user..."

echo "All tests completed!"
